const Category = require('../models/category');
const async = require('async');
const fetch = require('node-fetch');
const { createApi } = require('unsplash-js');
require('dotenv').config();

const unsplash = createApi({
    accessKey: process.env.UNSPLASH_ACCESS_KEY,
    fetch: fetch,
});

async function getRandomUnsplashPhoto() {
    return Promise.resolve(
        unsplash.photos.getRandom({}).then(result => {
            if (result.errors) { 
                console.log('Error occured: ', result.errors[0])
            } else { 
                const photo = result.response; 
                return photo.urls.full;
            }
        });
    );
}

exports.categories_list = (req, res, next) => { 
    async.waterfall([
        function (callback) {
            Category.find().exec(callback);
        },
        function (categories, callback) {
            console.log(getRandomUnsplashPhoto())
            const arr = categories.map(category => getRandomUnsplashPhoto()); 
            console.log(arr[0]);
            Promise.all(arr).then(images => {
                console.log(images);
                callback(null, { categories, images });
            }).catch(err => next(err));
        }
    ], (err, results) => {
        if (err) { return next(err) }
        res.render('category_list', {
            title: 'Categories', 
            categories: results.categories,
            img: results.images, 
        });
    });

    async.parallel({
        bg_image(callback) { 

        }, 
        categories(callback) { 
        }
    }, (err, results) => {

    });
};

exports.category_detail = (req, res) => { 
	res.send('Not yet implemented');
};

exports.update_category_get = (req, res) => { 
	res.send('Not yet implemented');
};

exports.update_category_post = (req, res) => { 
	res.send('Not yet implemented');
};

exports.delete_category_get = (req, res) => { 
	res.send('Not yet implemented');
};

exports.delete_category_post = (req, res) => { 
	res.send('Not yet implemented');
};

exports.create_category_get = (req, res) => { 
	res.send('Not yet implemented');
};

exports.create_category_post = (req, res) => { 
	res.send('Not yet implemented');
};

